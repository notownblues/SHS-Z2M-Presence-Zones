<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHS Z2M Presence Zone Configurator</title>
    <link rel="stylesheet" href="/src/style.css">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>SHS Z2M Presence Zone Configurator</h1>
            <div class="connection-status">
                <span class="status-indicator" id="mqttStatus"></span>
                <span id="mqttStatusText">Disconnected from MQTT</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel: Visualization -->
            <section class="visualization-panel">
                <!-- Drawing Toolbar -->
                <div class="drawing-toolbar">
                    <div class="toolbar-group">
                        <button class="tool-btn active" data-mode="select" title="Select / Edit">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 3l14 9-7 2-3 7-4-18z"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="draw-rectangle" title="Draw Rectangle Zone">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="1"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="draw-polygon" title="Draw Polygon Zone">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 3L21 9L18 20H6L3 9L12 3Z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="table" title="Place Table">
                            <!-- Table (top-down with wood grain) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="2" y="2" width="20" height="20" rx="2" fill="#6B4423"/>
                                <rect x="4" y="4" width="16" height="16" rx="1" fill="#D4A574"/>
                                <line x1="5" y1="8" x2="19" y2="8" stroke="#8B5A2B" stroke-width="0.8" opacity="0.4"/>
                                <line x1="5" y1="12" x2="19" y2="12" stroke="#8B5A2B" stroke-width="0.8" opacity="0.4"/>
                                <line x1="5" y1="16" x2="19" y2="16" stroke="#8B5A2B" stroke-width="0.8" opacity="0.4"/>
                                <rect x="8" y="10" width="8" height="4" rx="1" fill="#6B4423" opacity="0.2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="chair" title="Place Chair">
                            <!-- Armchair (top-down) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="5" y="2" width="14" height="7" rx="2" fill="#C05A38"/>
                                <rect x="3" y="6" width="18" height="12" rx="2" fill="#E07850"/>
                                <rect x="6" y="8" width="12" height="8" rx="1" fill="#F09070"/>
                                <rect x="1" y="5" width="4" height="11" rx="1" fill="#C05A38"/>
                                <rect x="19" y="5" width="4" height="11" rx="1" fill="#C05A38"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="bed" title="Place Bed">
                            <!-- Bed (top-down) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="2" y="2" width="20" height="20" rx="2" fill="#5D4037"/>
                                <rect x="4" y="4" width="16" height="16" rx="1" fill="#E8E8E8"/>
                                <rect x="2" y="2" width="4" height="20" rx="1" fill="#4A3228"/>
                                <rect x="7" y="5" width="5" height="6" rx="1" fill="#F5F0E6"/>
                                <rect x="7" y="13" width="5" height="6" rx="1" fill="#F5F0E6"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="sofa" title="Place Sofa">
                            <!-- Sofa (top-down) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="3" y="2" width="18" height="6" rx="2" fill="#3A5A8A"/>
                                <rect x="2" y="5" width="20" height="14" rx="2" fill="#4A6FA5"/>
                                <rect x="4" y="7" width="7" height="10" rx="1" fill="#6090C0"/>
                                <rect x="13" y="7" width="7" height="10" rx="1" fill="#6090C0"/>
                                <rect x="1" y="4" width="3" height="14" rx="1" fill="#3A5A8A"/>
                                <rect x="20" y="4" width="3" height="14" rx="1" fill="#3A5A8A"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="cabinet" title="Place Cabinet">
                            <!-- Cabinet (top-down) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="2" y="2" width="20" height="20" rx="2" fill="#5D4037"/>
                                <rect x="4" y="4" width="16" height="16" rx="1" fill="#8D6E63"/>
                                <line x1="4" y1="12" x2="20" y2="12" stroke="#4A3228" stroke-width="2"/>
                                <line x1="12" y1="13" x2="12" y2="19" stroke="#4A3228" stroke-width="2"/>
                                <circle cx="9" cy="16" r="1.5" fill="#FFD700"/>
                                <circle cx="15" cy="16" r="1.5" fill="#FFD700"/>
                                <circle cx="12" cy="8" r="1.5" fill="#FFD700"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="lamp" title="Place Lamp">
                            <!-- Lamp (top-down with glow) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" fill="#FFFACD" opacity="0.3"/>
                                <circle cx="12" cy="12" r="7" fill="#F0E68C"/>
                                <circle cx="12" cy="12" r="5" fill="#FFFACD"/>
                                <circle cx="12" cy="12" r="2" fill="#DAA520"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="place-furniture" data-furniture="plant" title="Place Plant">
                            <!-- Plant (top-down) -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <circle cx="8" cy="14" r="5" fill="#388E3C"/>
                                <circle cx="16" cy="14" r="5" fill="#388E3C"/>
                                <circle cx="12" cy="10" r="6" fill="#4CAF50"/>
                                <circle cx="9" cy="12" r="4" fill="#4CAF50"/>
                                <circle cx="15" cy="12" r="4" fill="#4CAF50"/>
                                <ellipse cx="12" cy="19" rx="4" ry="2" fill="#8B5A2B"/>
                            </svg>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button class="tool-btn" data-mode="place-entrance" title="Mark Door/Entrance">
                            <!-- Door swing arc -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <path d="M4 4 L4 20" stroke="#7F8C8D" stroke-width="2.5" stroke-linecap="round"/>
                                <path d="M4 4 L20 4" stroke="#5D6D7E" stroke-width="2.5" stroke-linecap="round"/>
                                <path d="M4 4 A16 16 0 0 1 20 20" stroke="#2C3E50" stroke-width="1.5" stroke-dasharray="3 3" fill="none"/>
                                <circle cx="4" cy="4" r="2.5" fill="#5D6D7E"/>
                                <circle cx="16" cy="4" r="2" fill="#95A5A6"/>
                            </svg>
                        </button>
                        <button class="tool-btn" data-mode="draw-edge" title="Draw Room Edge (Grey-out Area)">
                            <!-- Wall/border icon -->
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <rect x="2" y="2" width="20" height="20" rx="2" fill="none" stroke="#7F8C8D" stroke-width="2" stroke-dasharray="4 2"/>
                                <rect x="4" y="4" width="6" height="16" fill="#6B7280" opacity="0.6"/>
                            </svg>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button class="tool-btn" id="rotateMapBtn" title="Rotate Map 90°">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 109-9"/>
                                <path d="M12 3L9 6l3 3"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Sensor Status Bar - between toolbar and canvas -->
                <div class="sensor-status-bar" id="sensorStatusBar">
                    <div class="status-item">
                        <span class="status-label">Targets:</span>
                        <span class="status-value" id="targetCount">0</span>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-item">
                        <span class="status-label">Status:</span>
                        <span class="status-value" id="occupancy">Clear</span>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="radarCanvas" width="600" height="600"></canvas>

                    <!-- Floating Action Buttons for Selected Shape -->
                    <div class="shape-actions" id="shapeActions" style="display: none;">
                        <button class="shape-action-btn" id="moveShapeBtn" title="Move">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
                            </svg>
                        </button>
                        <button class="shape-action-btn" id="rotateShapeBtn" title="Rotate 45°">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M3 12a9 9 0 109-9"/>
                                <path d="M12 3L9 6l3 3"/>
                            </svg>
                        </button>
                        <button class="shape-action-btn size-btn" id="decreaseSizeBtn" title="Decrease Size">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M5 12h14"/>
                            </svg>
                        </button>
                        <button class="shape-action-btn size-btn" id="increaseSizeBtn" title="Increase Size">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                        </button>
                        <button class="shape-action-btn delete" id="deleteShapeBtn" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Done Button for Placement Mode -->
                    <div class="placement-done" id="placementDone" style="display: none;">
                        <button class="done-btn" id="doneBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Done
                        </button>
                        <span class="done-hint">Press Esc to cancel</span>
                    </div>
                </div>

            </section>

            <!-- Right Panel: Controls -->
            <aside class="controls-panel">
                <!-- Room & Sensor Settings -->
                <section class="control-section">
                    <h2>Room & Sensor</h2>
                    <div class="form-group">
                        <label for="mqttTopic">MQTT Topic</label>
                        <input type="text" id="mqttTopic" placeholder="zigbee2mqtt/SHS01" value="">
                        <small class="help-text">Zigbee2MQTT topic for your sensor (e.g., zigbee2mqtt/SHS01).</small>
                    </div>
                    <div class="form-group">
                        <label for="roomName">Room Name</label>
                        <div class="input-with-button">
                            <input type="text" id="roomName" placeholder="Living Room" value="">
                            <button id="saveRoomBtn" class="btn btn-success btn-small" title="Save room configuration">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Save
                            </button>
                            <button id="deleteRoomBtn" class="btn btn-danger btn-small" title="Delete room configuration">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                        <small class="help-text">Name for this room configuration (used for saving).</small>
                    </div>
                    <div class="form-group">
                        <label for="sensorSelector">Saved Rooms</label>
                        <select id="sensorSelector">
                            <option value="">-- Select a saved room --</option>
                        </select>
                        <small class="help-text">Select a saved room to load its configuration.</small>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <button id="positionReportingBtn" class="btn btn-secondary" disabled>
                            Enable Position Reporting
                        </button>
                        <small style="color: #8b949e;">
                            Toggle X/Y position updates via Zigbee. Enable when configuring zones, disable after.
                        </small>
                    </div>
                </section>

                <!-- Zone Configuration -->
                <section class="control-section">
                    <div class="section-header">
                        <h2>Zone Configuration</h2>
                        <span class="auto-save-indicator" id="saveIndicator">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Saved
                        </span>
                    </div>

                    <!-- Zone Type Selection -->
                    <div class="form-group">
                        <label for="zoneType">Zone Mode</label>
                        <select id="zoneType">
                            <option value="0">Off - Detect All Targets</option>
                            <option value="1">Include - Only Inside Zones</option>
                            <option value="2">Exclude - Only Outside Zones</option>
                        </select>
                        <small class="help-text">Include: Only detect targets inside zones. Exclude: Ignore targets inside zones.</small>
                    </div>

                    <!-- Zone Summary Cards -->
                    <div class="zone-cards">
                        <div class="zone-card" id="zone1Card" data-zone="1">
                            <div class="zone-card-header">
                                <div class="zone-card-color zone1"></div>
                                <span class="zone-card-title">Zone 1</span>
                                <span id="zone1Status" class="status-badge">Clear</span>
                            </div>
                            <div class="zone-card-info">
                                <span id="zone1Info" class="zone-info-text">Click to draw on map</span>
                            </div>
                            <div class="zone-card-type">
                                <select id="zone1Type" class="zone-type-select" title="Zone Type">
                                    <option value="detection">Detection</option>
                                    <option value="interference">Interference</option>
                                </select>
                            </div>
                        </div>

                        <div class="zone-card" id="zone2Card" data-zone="2">
                            <div class="zone-card-header">
                                <div class="zone-card-color zone2"></div>
                                <span class="zone-card-title">Zone 2</span>
                                <span id="zone2Status" class="status-badge">Clear</span>
                            </div>
                            <div class="zone-card-info">
                                <span id="zone2Info" class="zone-info-text">Click to draw on map</span>
                            </div>
                            <div class="zone-card-type">
                                <select id="zone2Type" class="zone-type-select" title="Zone Type">
                                    <option value="detection">Detection</option>
                                    <option value="interference">Interference</option>
                                </select>
                            </div>
                        </div>

                        <div class="zone-card" id="zone3Card" data-zone="3">
                            <div class="zone-card-header">
                                <div class="zone-card-color zone3"></div>
                                <span class="zone-card-title">Zone 3</span>
                                <span id="zone3Status" class="status-badge">Clear</span>
                            </div>
                            <div class="zone-card-info">
                                <span id="zone3Info" class="zone-info-text">Click to draw on map</span>
                            </div>
                            <div class="zone-card-type">
                                <select id="zone3Type" class="zone-type-select" title="Zone Type">
                                    <option value="detection">Detection</option>
                                    <option value="interference">Interference</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <p class="help-text" style="margin-bottom: var(--spacing-md);">
                        Click a zone card to select it. Draw zones on map, or click existing zones to edit. Auto-saves locally.
                    </p>

                    <!-- Hidden inputs to maintain state compatibility -->
                    <input type="hidden" id="zone1Enable" value="false">
                    <input type="hidden" id="zone1X1" value="-1500">
                    <input type="hidden" id="zone1Y1" value="0">
                    <input type="hidden" id="zone1X2" value="1500">
                    <input type="hidden" id="zone1Y2" value="3000">
                    <input type="hidden" id="zone2Enable" value="false">
                    <input type="hidden" id="zone2X1" value="-1500">
                    <input type="hidden" id="zone2Y1" value="0">
                    <input type="hidden" id="zone2X2" value="1500">
                    <input type="hidden" id="zone2Y2" value="3000">
                    <input type="hidden" id="zone3Enable" value="false">
                    <input type="hidden" id="zone3X1" value="-1500">
                    <input type="hidden" id="zone3Y1" value="0">
                    <input type="hidden" id="zone3X2" value="1500">
                    <input type="hidden" id="zone3Y2" value="3000">

                    <div class="button-group">
                        <button id="applyZonesBtn" class="btn btn-primary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save to Sensor
                        </button>
                        <button id="resetZonesBtn" class="btn btn-secondary">Clear All</button>
                    </div>
                </section>

                <!-- Live Target Data -->
                <section class="control-section">
                    <h2>Live Target Data</h2>
                    <div id="targetList" class="target-list">
                        <p class="text-muted">No targets detected</p>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <script type="module" src="/src/main.js"></script>
</body>
</html>
